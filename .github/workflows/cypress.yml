name: Run Cypress Tests

on:
  schedule:
    # Daily at 2:30 PM PKT â†’ 09:30 UTC
    - cron: '5 11 * * *'
jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Checkout code
      # -----------------------------
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: main   # <-- branch name goes here

      # -----------------------------
      # Setup Node.js
      # -----------------------------
      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'  # speeds up install

      # -----------------------------
      # Install dependencies
      # -----------------------------
      - name: Install Dependencies
        run: npm ci

      # -----------------------------
      # Build React App (fast + env injected)
      # -----------------------------
      - name: Build React App
        run: npm run build
        env:
          CI: false
          NODE_OPTIONS: "--max-old-space-size=4096"
          GENERATE_SOURCEMAP: false
           # React build-time env vars
          REACT_APP_BACKEND_API: "https://dev-api.pretectum.io/"
          REACT_APP_BUCKET_NAME: "pretectum-dev"
          REACT_APP_BUCKET_REGION: "us-east-2"
          REACT_APP_IDENTITY_POOL_ID: "us-east-2:4f8d7c88-8890-4de1-9c00-d9b635199ee8"
          REACT_APP_WEB_SOCKET: "wss://bnnl437dqd.execute-api.us-east-2.amazonaws.com/dev"
          REACT_APP_GMAPS_API_KEY: "SET"
          REACT_APP_NOVU_APPLICATION_IDENTIFIER: "gBy6dc7D3weB"
          SKIP_PREFLIGHT_CHECK: "true"

          # Amplify
          AMPLIFY_NATIVECLIENT_ID: "2bi4o2llifpcjnfpv0no1slj0k"
          AMPLIFY_USERPOOL_ID: "us-east-2_C7Zl7OTI1"
          AMPLIFY_WEBCLIENT_ID: "61junkfaas0egho45e9q71uljj"

      # -----------------------------
      # Run Cypress tests
      # -----------------------------
      - name: Cypress Run
        uses: cypress-io/github-action@v6
        with:
          start: npx serve -s build -l 3000
          wait-on: 'http://127.0.0.1:3000'
          wait-on-timeout: 180
          project: .
          browser: chrome
          spec: src/cypress/e2e/18_Cypress_daily.cy.ts   # <- exact file path
        env:
          CYPRESS_BASE_URL: http://127.0.0.1:3000
          NODE_OPTIONS: "--openssl-legacy-provider"
          tenantId: "20240809094032340xyo4ktshjhuqlxn"
          userId: "d36072d8-8096-49dc-979d-edfd6df37355"

      # -----------------------------
      # Upload artifacts if tests fail
      # -----------------------------
      - name: Upload Cypress Artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-results
          path: |
            cypress/videos/
            cypress/screenshots/
          if-no-files-found: ignore
